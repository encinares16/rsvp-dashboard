<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RSVP Management Dashboard</title>
  <style>
    /* ‚îÄ‚îÄ Theme Variables ‚îÄ‚îÄ */
    :root[data-theme="dark"] {
      --bg: #121212;
      --card-bg: #1e1e1e;
      --border: #333333;
      --text-main: #f0f0f0;
      --text-muted: #a0a0a0;
      --accent: #ffffff;
      --th-bg: #262626;
      --success: #10b981;
      --danger: #ef4444;
      --toggle-bg: #333;
      --toggle-icon: "‚òÄÔ∏è";
      --shadow: rgba(0,0,0,0.4);
      --pagination-hover: #2a2a2a;
      --pagination-active-bg: #ffffff;
      --pagination-active-color: #121212;
    }

    :root[data-theme="light"] {
      --bg: #f4f5f7;
      --card-bg: #ffffff;
      --border: #e0e0e0;
      --text-main: #1a1a1a;
      --text-muted: #6b7280;
      --accent: #111827;
      --th-bg: #f9fafb;
      --success: #059669;
      --danger: #dc2626;
      --toggle-bg: #e5e7eb;
      --toggle-icon: "üåô";
      --shadow: rgba(0,0,0,0.1);
      --pagination-hover: #f3f4f6;
      --pagination-active-bg: #111827;
      --pagination-active-color: #ffffff;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      padding: 40px 20px;
      background: var(--bg);
      color: var(--text-main);
      line-height: 1.6;
      transition: background 0.25s, color 0.25s;
    }

    .container { max-width: 1000px; margin: 0 auto; }

    /* ‚îÄ‚îÄ Theme Toggle ‚îÄ‚îÄ */
    .theme-toggle {
      position: fixed;
      top: 18px;
      right: 18px;
      z-index: 999;
      background: var(--toggle-bg);
      border: 1px solid var(--border);
      border-radius: 50px;
      padding: 6px 14px;
      font-size: 0.78rem;
      cursor: pointer;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      box-shadow: 0 2px 8px var(--shadow);
    }
    .theme-toggle:hover { opacity: 0.85; }

    h1 { text-align: center; font-weight: 700; font-size: 2.2rem; margin-bottom: 40px; color: var(--accent); letter-spacing: -0.02em; }
    h2 { margin-top: 50px; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); border-bottom: 1px solid var(--border); padding-bottom: 10px; }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 40px;
    }

    .stat {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
      text-align: center;
      transition: background 0.25s, border-color 0.25s;
    }

    .stat strong { display: block; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 8px; }
    .stat span { font-size: 1.8rem; font-weight: 700; color: var(--accent); }

    /* ‚îÄ‚îÄ Table Container ‚îÄ‚îÄ */
    .table-container {
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border);
      overflow-x: auto;
      margin-top: 20px;
      -webkit-overflow-scrolling: touch;
      transition: background 0.25s, border-color 0.25s;
    }

    /* Guest messages: no row scrolling (no overflow-x) */
    .table-container.no-scroll {
      overflow-x: visible;
    }

    table { width: 100%; border-collapse: collapse; min-width: 400px; }

    /* Guest messages table: no min-width so it won't trigger horizontal scroll */
    .no-scroll table { min-width: unset; }

    th {
      background: var(--th-bg);
      padding: 14px;
      text-align: left;
      font-size: 0.85rem;
      text-transform: uppercase;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      transition: background 0.25s;
    }
    th.center, td.center { text-align: center; }
    td { padding: 14px; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
    tr:last-child td { border-bottom: none; }

    .row-num { color: var(--text-muted); font-size: 0.8rem; margin-right: 2px; font-weight: normal; }

    .badge { padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
    .badge-yes { background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid var(--success); }
    .badge-no { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid var(--danger); }

    /* ‚îÄ‚îÄ Message Styling ‚îÄ‚îÄ */
    .message-cell { padding: 20px 14px 10px 14px !important; }
    .note-header { display: block; margin-bottom: 4px; }
    .note-text { color: var(--text-muted); font-style: italic; display: block; margin: 12px 0; font-size: 0.9rem; }
    .footer-row { display: flex; justify-content: flex-end; margin-top: 5px; }
    .timestamp { font-size: 0.60rem; color: var(--text-muted); font-weight: 300; opacity: 0.7; }

    .btn-archive, .btn-restore {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: all 0.15s;
    }
    .btn-archive:hover { border-color: var(--danger); color: var(--danger); }
    .btn-restore:hover { border-color: var(--success); color: var(--success); }

    .archived-row td { opacity: 0.5; }

    /* ‚îÄ‚îÄ Pagination ‚îÄ‚îÄ */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 14px;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .pagination.hidden { display: none; }

    .page-info {
      font-size: 0.78rem;
      color: var(--text-muted);
      text-align: center;
      padding: 4px 0 10px;
    }

    .page-info.hidden { display: none; }

    .pg-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 5px 11px;
      border-radius: 4px;
      font-size: 0.78rem;
      cursor: pointer;
      transition: all 0.15s;
      min-width: 34px;
    }
    .pg-btn:hover:not(:disabled) { background: var(--pagination-hover); color: var(--text-main); }
    .pg-btn.active {
      background: var(--pagination-active-bg);
      color: var(--pagination-active-color);
      border-color: var(--pagination-active-bg);
      font-weight: 700;
    }
    .pg-btn:disabled { opacity: 0.3; cursor: default; }

    /* ‚îÄ‚îÄ Login Screen ‚îÄ‚îÄ */
    #login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      flex-direction: column;
      gap: 20px;
    }

    @media (max-width: 600px) {
      .stats { grid-template-columns: 1fr 1fr; }
      th, td { padding: 10px; font-size: 0.8rem; }
      .theme-toggle { top: 12px; right: 12px; }
    }
  </style>
</head>
<body>

  <!-- Theme Toggle Button -->
  <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
    <span id="theme-icon">‚òÄÔ∏è</span>
    <span id="theme-label">Light Mode</span>
  </button>

  <!-- Login Screen -->
  <div id="login-screen">
    <h1 style="margin:0;">RSVP DASHBOARD</h1>
    <p style="color:var(--text-muted); margin:0;">Sign in to access the dashboard</p>
    <button id="btn-signin" style="
      display:flex; align-items:center; gap:10px;
      background:#fff; color:#333; border:none;
      padding:12px 24px; border-radius:6px;
      font-size:0.95rem; font-weight:600; cursor:pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    ">
      <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
      Sign in with Google
    </button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard-content" style="display:none;">
    <div class="container">
      <div style="text-align:center; margin-bottom:40px;">
        <h1 style="margin:0;">RSVP DASHBOARD</h1>
      </div>

      <div class="stats">
        <div class="stat"><strong>Total RSVPs</strong> <span id="total-rsvps">0</span></div>
        <div class="stat"><strong>Attending</strong> <span id="attending-count">0</span></div>
        <div class="stat"><strong>Declined</strong> <span id="not-attending-count">0</span></div>
        <div class="stat"><strong>Guest Count</strong> <span id="total-guests">0</span></div>
      </div>

      <!-- Guest List -->
      <h2>Guest List</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width:8px;">#</th>
              <th>Name</th>
              <th>Status</th>
              <th class="center">Guests</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="rsvp-table-body"></tbody>
        </table>
        <div class="pagination hidden" id="rsvp-pagination"></div>
      </div>
      <div class="page-info hidden" id="rsvp-page-info"></div>

      <!-- Guest Messages -->
      <h2>Guest Messages</h2>
      <div class="table-container no-scroll">
        <table>
          <tbody id="notes-table-body"></tbody>
        </table>
        <div class="pagination hidden" id="notes-pagination"></div>
      </div>
      <div class="page-info hidden" id="notes-page-info"></div>

      <!-- Archived -->
      <h2>Guest Archived Response</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width:8px;">#</th>
              <th>Name</th>
              <th>Status</th>
              <th class="center">Guests</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="archived-table-body"></tbody>
        </table>
        <div class="pagination hidden" id="archived-pagination"></div>
      </div>
      <div class="page-info hidden" id="archived-page-info"></div>
    </div>

    <!-- Sign Out Footer -->
    <div style="text-align:center; padding:40px 20px 30px;">
      <span id="user-name" style="font-size:0.85rem; color:var(--text-muted); display:block; margin-bottom:10px;"></span>
      <button id="btn-signout" style="
        background:none; border:1px solid var(--border);
        color:var(--text-muted); padding:8px 20px;
        border-radius:4px; font-size:0.8rem; cursor:pointer;
        transition: all 0.15s;
      " onmouseover="this.style.borderColor='#ef4444';this.style.color='#ef4444'"
         onmouseout="this.style.borderColor=getComputedStyle(document.documentElement).getPropertyValue('--border').trim();this.style.color=getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim()">
        Sign out
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

    // ‚îÄ‚îÄ Firebase Config ‚îÄ‚îÄ
    const firebaseConfig = {
      apiKey: "AIzaSyCjp0DvbPWSO9PJCscO2PZDHmYCOxBfoa8",
      authDomain: "rsvp-app-cafd2.firebaseapp.com",
      projectId: "rsvp-app-cafd2",
      storageBucket: "rsvp-app-cafd2.firebasestorage.app",
      messagingSenderId: "1046629958084",
      appId: "1:1046629958084:web:23772b022b2b3dc8a9a491"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const rsvpCollection = collection(db, "rsvps");
    const rsvpQuery = query(rsvpCollection, orderBy("submittedAt", "asc"));

    let unsubscribeSnapshot = null;

    // ‚îÄ‚îÄ Theme Toggle ‚îÄ‚îÄ
    const html = document.documentElement;
    const toggleBtn = document.getElementById("theme-toggle");
    const themeIcon = document.getElementById("theme-icon");
    const themeLabel = document.getElementById("theme-label");

    function applyTheme(theme) {
      html.setAttribute("data-theme", theme);
      if (theme === "dark") {
        themeIcon.textContent = "‚òÄÔ∏è";
        themeLabel.textContent = "Light Mode";
      } else {
        themeIcon.textContent = "üåô";
        themeLabel.textContent = "Dark Mode";
      }
      localStorage.setItem("rsvp-theme", theme);
    }

    // Load saved theme
    const savedTheme = localStorage.getItem("rsvp-theme") || "dark";
    applyTheme(savedTheme);

    toggleBtn.addEventListener("click", () => {
      const current = html.getAttribute("data-theme");
      applyTheme(current === "dark" ? "light" : "dark");
    });

    // ‚îÄ‚îÄ Auth ‚îÄ‚îÄ
    document.getElementById("btn-signin").addEventListener("click", () => {
      signInWithPopup(auth, provider).catch(err => console.error(err));
    });

    document.getElementById("btn-signout").addEventListener("click", () => signOut(auth));

    const ALLOWED_EMAILS = ["jerome.encinares0016@gmail.com", "jstnrsdc@gmail.com"];

    onAuthStateChanged(auth, (user) => {
      if (user) {
        if (!ALLOWED_EMAILS.includes(user.email)) {
          signOut(auth);
          alert("Access denied. You are not authorized to view this dashboard.");
          return;
        }
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("dashboard-content").style.display = "block";
        document.getElementById("user-name").textContent = user.displayName;

        if (!unsubscribeSnapshot) {
          unsubscribeSnapshot = onSnapshot(rsvpQuery, (snapshot) => {
            const rsvps = [];
            snapshot.forEach(d => rsvps.push({ id: d.id, ...d.data() }));
            updateDashboard(rsvps);
          });
        }
      } else {
        document.getElementById("login-screen").style.display = "flex";
        document.getElementById("dashboard-content").style.display = "none";
        if (unsubscribeSnapshot) { unsubscribeSnapshot(); unsubscribeSnapshot = null; }
      }
    });

    async function setArchived(id, value) {
      await updateDoc(doc(db, "rsvps", id), { archived: value });
    }

    // ‚îÄ‚îÄ Pagination State ‚îÄ‚îÄ
    const PAGE_SIZE = 15;
    const pages = { rsvp: 1, notes: 1, archived: 1 };

    // Stored full row data for re-rendering
    let allRsvpRows = [];
    let allNotesRows = [];
    let allArchivedRows = [];

    // ‚îÄ‚îÄ Pagination Renderer ‚îÄ‚îÄ
    function renderPagination(containerId, infoId, totalItems, currentPage, tableBodyId, renderFn) {
      const totalPages = Math.ceil(totalItems / PAGE_SIZE);
      const container = document.getElementById(containerId);
      const info = document.getElementById(infoId);

      if (totalPages <= 1) {
        container.classList.add("hidden");
        info.classList.add("hidden");
        return;
      }

      container.classList.remove("hidden");
      info.classList.remove("hidden");

      const start = (currentPage - 1) * PAGE_SIZE + 1;
      const end = Math.min(currentPage * PAGE_SIZE, totalItems);
      info.textContent = `Showing ${start}‚Äì${end} of ${totalItems}`;

      container.innerHTML = "";

      // Prev button
      const prev = document.createElement("button");
      prev.className = "pg-btn";
      prev.textContent = "‚Üê";
      prev.disabled = currentPage === 1;
      prev.addEventListener("click", () => {
        pages[tableBodyId] = currentPage - 1;
        renderFn();
      });
      container.appendChild(prev);

      // Page numbers (show up to 7 pages with ellipsis)
      const range = getPageRange(currentPage, totalPages);
      range.forEach(p => {
        if (p === "‚Ä¶") {
          const ellipsis = document.createElement("span");
          ellipsis.textContent = "‚Ä¶";
          ellipsis.style.cssText = "padding:5px 4px;color:var(--text-muted);font-size:0.78rem;";
          container.appendChild(ellipsis);
        } else {
          const btn = document.createElement("button");
          btn.className = "pg-btn" + (p === currentPage ? " active" : "");
          btn.textContent = p;
          btn.addEventListener("click", () => {
            pages[tableBodyId] = p;
            renderFn();
          });
          container.appendChild(btn);
        }
      });

      // Next button
      const next = document.createElement("button");
      next.className = "pg-btn";
      next.textContent = "‚Üí";
      next.disabled = currentPage === totalPages;
      next.addEventListener("click", () => {
        pages[tableBodyId] = currentPage + 1;
        renderFn();
      });
      container.appendChild(next);
    }

    function getPageRange(current, total) {
      if (total <= 7) return Array.from({ length: total }, (_, i) => i + 1);
      if (current <= 4) return [1, 2, 3, 4, 5, "‚Ä¶", total];
      if (current >= total - 3) return [1, "‚Ä¶", total - 4, total - 3, total - 2, total - 1, total];
      return [1, "‚Ä¶", current - 1, current, current + 1, "‚Ä¶", total];
    }

    // ‚îÄ‚îÄ Table Renderers ‚îÄ‚îÄ
    function renderRsvpTable() {
      const tbody = document.getElementById("rsvp-table-body");
      tbody.innerHTML = "";
      const start = (pages.rsvp - 1) * PAGE_SIZE;
      const slice = allRsvpRows.slice(start, start + PAGE_SIZE);
      slice.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><span class="row-num">${item.index}</span></td>
          <td><strong>${item.displayName}</strong></td>
          <td><span class="badge ${item.isAttending ? 'badge-yes' : 'badge-no'}">${item.isAttending ? 'Attending' : 'No'}</span></td>
          <td class="center">${item.guestCount}</td>
          <td><button class="btn-archive">Archive</button></td>`;
        row.querySelector(".btn-archive").addEventListener("click", () => setArchived(item.id, true));
        tbody.appendChild(row);
      });
      renderPagination("rsvp-pagination", "rsvp-page-info", allRsvpRows.length, pages.rsvp, "rsvp", renderRsvpTable);
    }

    function renderNotesTable() {
      const tbody = document.getElementById("notes-table-body");
      tbody.innerHTML = "";
      const start = (pages.notes - 1) * PAGE_SIZE;
      const slice = allNotesRows.slice(start, start + PAGE_SIZE);
      slice.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="message-cell">
            <div class="note-header">
              <span class="row-num">${item.index}.</span>
              <strong>${item.fullName}</strong>
            </div>
            <div class="note-text">${item.note}</div>
            <div class="footer-row">
              <span class="timestamp">${item.dateTime}</span>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
      renderPagination("notes-pagination", "notes-page-info", allNotesRows.length, pages.notes, "notes", renderNotesTable);
    }

    function renderArchivedTable() {
      const tbody = document.getElementById("archived-table-body");
      tbody.innerHTML = "";
      const start = (pages.archived - 1) * PAGE_SIZE;
      const slice = allArchivedRows.slice(start, start + PAGE_SIZE);
      slice.forEach(item => {
        const row = document.createElement("tr");
        row.classList.add("archived-row");
        row.innerHTML = `
          <td><span class="row-num">${item.index}</span></td>
          <td><strong>${item.displayName}</strong></td>
          <td><span class="badge ${item.isAttending ? 'badge-yes' : 'badge-no'}">${item.isAttending ? 'Attending' : 'No'}</span></td>
          <td class="center">${item.guestCount}</td>
          <td><button class="btn-restore">Restore</button></td>`;
        row.querySelector(".btn-restore").addEventListener("click", () => setArchived(item.id, false));
        tbody.appendChild(row);
      });
      renderPagination("archived-pagination", "archived-page-info", allArchivedRows.length, pages.archived, "archived", renderArchivedTable);
    }

    // ‚îÄ‚îÄ Main Dashboard Update ‚îÄ‚îÄ
    function updateDashboard(rsvps) {
      allRsvpRows = [];
      allNotesRows = [];
      allArchivedRows = [];

      let attendingCount = 0, notAttendingCount = 0, totalGuests = 0;
      let noteIndex = 1, activeIndex = 1, archivedIndex = 1;

      const isMobile = window.innerWidth <= 600;

      rsvps.forEach((rsvp) => {
        const fullName = rsvp.name ? rsvp.name.trim() : '';
        const isArchived = rsvp.archived === true;
        const isAttending = rsvp.attending === "yes";

        const nameParts = fullName.split(' ');
        const lInitial = nameParts.length > 1 ? `${nameParts[nameParts.length - 1].charAt(0)}.` : '';
        const abbreviated = nameParts.length > 1 ? `${nameParts[0]} ${lInitial}` : fullName;
        const listDisplayName = isMobile ? abbreviated : fullName;

        let combinedDateTime = "No date available";
        if (rsvp.submittedAt) {
          const dateObj = rsvp.submittedAt.toDate ? rsvp.submittedAt.toDate() : new Date(rsvp.submittedAt);
          const datePart = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
          const timePart = dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
          combinedDateTime = `${datePart}  ‚Ä¢  ${timePart}`;
        }

        if (!isArchived) {
          if (isAttending) { attendingCount++; totalGuests += (parseInt(rsvp.guestCount) || 0); }
          else { notAttendingCount++; }

          allRsvpRows.push({ id: rsvp.id, index: activeIndex++, displayName: listDisplayName, isAttending, guestCount: rsvp.guestCount || 0 });

          if (rsvp.note && rsvp.note.trim() !== "") {
            allNotesRows.push({ index: noteIndex++, fullName, note: rsvp.note, dateTime: combinedDateTime });
          }
        } else {
          allArchivedRows.push({ id: rsvp.id, index: archivedIndex++, displayName: listDisplayName, isAttending, guestCount: rsvp.guestCount || 0 });
        }
      });

      // Reset to page 1 on data refresh
      pages.rsvp = 1;
      pages.notes = 1;
      pages.archived = 1;

      renderRsvpTable();
      renderNotesTable();
      renderArchivedTable();

      document.getElementById("total-rsvps").innerText = rsvps.filter(r => !r.archived).length;
      document.getElementById("attending-count").innerText = attendingCount;
      document.getElementById("not-attending-count").innerText = notAttendingCount;
      document.getElementById("total-guests").innerText = totalGuests;
    }
  </script>
</body>
</html>